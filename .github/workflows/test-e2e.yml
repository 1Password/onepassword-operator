name: E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ['**']   # run for PRs targeting any branch (main and others)
    paths-ignore: &ignore_paths
      - 'docs/**'
      - '*.md'
      - '.golangci.yml'
      - '.gitignore'
      - '.dockerignore'
      - 'LICENSE'
  push:
    branches: [main]
    paths-ignore: *ignore_paths
  repository_dispatch:
    types: [ ok-to-test-command ]

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('e2e-{0}', github.event.pull_request.head.ref) || format('e2e-{0}', github.event.client_payload.pull_request.head.ref) }}
  cancel-in-progress: true  # cancel previous job runs for the same branch

jobs:
  check-external-pr:
    runs-on: ubuntu-latest
    outputs:
      condition: ${{ steps.check.outputs.condition }}
    steps:
      - name: Check if PR is from external contributor
        id: check
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For pull_request events, check if PR is from external fork
            echo "PR head repo: ${{ github.event.pull_request.head.repo.full_name }}"
            if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
              echo "condition=pr-creation-forked" >> $GITHUB_OUTPUT
              echo "Setting condition=true (external fork PR creation)"
            else
              echo "condition=pr-creation-maintainer" >> $GITHUB_OUTPUT
              echo "Setting condition=false (internal PR creation)"
            fi
          else
            # For repository_dispatch events (ok-to-test), always return dispatch event
            echo "condition=dispatch-event" >> $GITHUB_OUTPUT
            echo "Setting condition=dispatch-event (external fork via dispatch)"
          fi

  # Run tests for:
  # 1. Internal PRs on pull_request events
  # 2. External PRs on repository_dispatch (ok-to-test) events
  e2e-test:
    needs: check-external-pr
    if: |
        (needs.check-external-pr.outputs.condition == 'pr-creation-maintainer')
        ||
        (github.event_name == 'repository_dispatch' && 
         needs.check-external-pr.outputs.condition == 'dispatch-event' &&
         github.event.client_payload.slash_command.args.named.sha != '' &&
         contains(
            github.event.client_payload.pull_request.head.sha,
            github.event.client_payload.slash_command.args.named.sha
         )
        )
    uses: ./.github/workflows/e2e-tests.yml
    secrets:
      OP_CONNECT_CREDENTIALS: ${{ secrets.OP_CONNECT_CREDENTIALS }}
      OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
