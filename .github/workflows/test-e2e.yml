name: E2E Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ['**']   # run for PRs targeting any branch (main and others)
    paths-ignore: &ignore_paths
      - 'docs/**'
      - '*.md'
      - '.golangci.yml'
      - '.gitignore'
      - '.dockerignore'
      - 'LICENSE'
  push:
    branches: [main]
    paths-ignore: *ignore_paths
  repository_dispatch:
    types: [ok-to-test]

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('e2e-{0}', github.event.pull_request.head.ref) || format('e2e-{0}', github.event.client_payload.pull_request.head.ref) }}
  cancel-in-progress: true  # cancel previous job runs for the same branch

jobs:
  check-external-pr:
    runs-on: ubuntu-latest
    outputs:
      is_external: ${{ steps.check.outputs.is_external }}
    steps:
      - name: Check if PR is from external contributor
        id: check
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For pull_request events, check if PR is from external fork
            if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
              echo "is_external=true" >> $GITHUB_OUTPUT
            else
              echo "is_external=false" >> $GITHUB_OUTPUT
            fi
          else
            # For repository_dispatch events (ok-to-test), check client_payload
            if [ "${{ github.event.client_payload.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
              echo "is_external=true" >> $GITHUB_OUTPUT
            else
              echo "is_external=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Run tests for:
  # 1. Internal PRs on pull_request events
  # 2. External PRs on repository_dispatch (ok-to-test) events
  e2e-test:
    needs: check-external-pr
    if: |
      always() && (
        (github.event_name == 'pull_request' && needs.check-external-pr.outputs.is_external == 'false')
        ||
        (github.event_name == 'repository_dispatch' && 
         needs.check-external-pr.outputs.is_external == 'true' &&
         github.event.client_payload.slash_command.args.named.sha != '' &&
         contains(
            github.event.client_payload.pull_request.head.sha,
            github.event.client_payload.slash_command.args.named.sha
         )
        )
      )
    uses: ./.github/workflows/e2e-tests.yml
    secrets:
      OP_CONNECT_CREDENTIALS: ${{ secrets.OP_CONNECT_CREDENTIALS }}
      OP_CONNECT_TOKEN: ${{ secrets.OP_CONNECT_TOKEN }}
      OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
